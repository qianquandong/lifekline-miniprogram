<!--result.wxml-->
<view class="container" catchtap="stopPropagation">
  <!-- 头部 -->
  <view class="header">
    <view class="header-content">
      <text class="back-btn" bindtap="goBack">← 返回</text>
      <text class="header-title">分析报告</text>
      <text class="header-placeholder"></text>
    </view>
  </view>

  <!-- 八字信息卡片 -->
  <view wx:if="{{bazi}}" class="bazi-card">
    <view class="bazi-card-title">八字信息</view>
    <view class="bazi-display">
      <text class="bazi-text">{{bazi.bazi}}</text>
    </view>
    <view class="bazi-info">
      <text>{{bazi.input.birthDate}} {{bazi.input.birthTime}} {{bazi.input.gender === 'male' ? '男' : '女'}}</text>
    </view>
  </view>

  <!-- 标签切换 -->
  <view class="tabs">
    <view 
      class="tab-item {{activeTab === 'report' ? 'active' : ''}}" 
      data-tab="report"
      bindtap="switchTab"
    >
      <text>分析报告</text>
    </view>
    <view 
      class="tab-item {{activeTab === 'chart' ? 'active' : ''}}" 
      data-tab="chart"
      bindtap="switchTab"
    >
      <text>运势K线</text>
    </view>
  </view>

  <!-- 分析报告 -->
  <view wx:if="{{activeTab === 'report' && analysisData}}" class="report-container">
    <!-- 性格分析 -->
    <view class="report-section">
      <view class="section-header" data-section="personality" bindtap="toggleSection">
        <text class="section-title">性格分析</text>
        <text class="section-toggle">{{expandedSections.personality ? '▼' : '▶'}}</text>
      </view>
      <view wx:if="{{expandedSections.personality}}" class="section-content">
        <text class="section-text">{{analysisData.personality}}</text>
      </view>
    </view>

    <!-- 事业分析 -->
    <view class="report-section">
      <view class="section-header" data-section="career" bindtap="toggleSection">
        <text class="section-title">事业分析</text>
        <text class="section-toggle">{{expandedSections.career ? '▼' : '▶'}}</text>
      </view>
      <view wx:if="{{expandedSections.career}}" class="section-content">
        <text class="section-text">{{analysisData.career}}</text>
      </view>
    </view>

    <!-- 财富分析 -->
    <view class="report-section">
      <view class="section-header" data-section="wealth" bindtap="toggleSection">
        <text class="section-title">财富分析</text>
        <text class="section-toggle">{{expandedSections.wealth ? '▼' : '▶'}}</text>
      </view>
      <view wx:if="{{expandedSections.wealth}}" class="section-content">
        <text class="section-text">{{analysisData.wealth}}</text>
      </view>
    </view>

    <!-- 婚姻分析 -->
    <view class="report-section">
      <view class="section-header" data-section="marriage" bindtap="toggleSection">
        <text class="section-title">婚姻分析</text>
        <text class="section-toggle">{{expandedSections.marriage ? '▼' : '▶'}}</text>
      </view>
      <view wx:if="{{expandedSections.marriage}}" class="section-content">
        <text class="section-text">{{analysisData.marriage}}</text>
      </view>
    </view>

    <!-- 健康分析 -->
    <view class="report-section">
      <view class="section-header" data-section="health" bindtap="toggleSection">
        <text class="section-title">健康分析</text>
        <text class="section-toggle">{{expandedSections.health ? '▼' : '▶'}}</text>
      </view>
      <view wx:if="{{expandedSections.health}}" class="section-content">
        <text class="section-text">{{analysisData.health}}</text>
      </view>
    </view>
  </view>

  <!-- K线图 -->
  <view wx:if="{{activeTab === 'chart' && analysisData}}" class="chart-container">
    <view class="chart-wrapper">
      <canvas 
        type="2d" 
        id="kline-canvas" 
        class="kline-canvas"
        style="width: {{chartWidth}}px; height: {{chartHeight}}px;"
        bindtap="onCanvasTap"
      ></canvas>
      
      <!-- 图例说明 -->
      <view class="chart-legend">
        <view class="legend-item">
          <view class="legend-color" style="background: #26a69a;"></view>
          <text>上涨</text>
        </view>
        <view class="legend-item">
          <view class="legend-color" style="background: #ef5350;"></view>
          <text>下跌</text>
        </view>
        <view class="legend-item">
          <view class="legend-color" style="background: #999;"></view>
          <text>平稳</text>
        </view>
        <view class="legend-hint">点击图表查看详情</view>
      </view>
    </view>

    <!-- 数据点详情弹窗 -->
    <view wx:if="{{showPointDetail && selectedPoint}}" class="point-detail-modal" bindtap="closePointDetail">
      <view class="point-detail-content" catchtap="stopPropagation">
        <view class="point-detail-header">
          <text class="point-detail-title">{{selectedPoint.age}}岁运势</text>
          <text class="point-detail-close" bindtap="closePointDetail">×</text>
        </view>
        <view class="point-detail-body">
          <view class="point-detail-item">
            <text class="point-label">年龄：</text>
            <text class="point-value">{{selectedPoint.age}}岁</text>
          </view>
          <view class="point-detail-item">
            <text class="point-label">运势分数：</text>
            <text class="point-value score-{{selectedPoint.trend}}">{{selectedPoint.score}}分</text>
          </view>
          <view class="point-detail-item">
            <text class="point-label">趋势：</text>
            <text class="point-value">
              {{selectedPoint.trend === 'up' ? '上升' : selectedPoint.trend === 'down' ? '下降' : '平稳'}}
            </text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
